AWSTemplateFormatVersion: '2010-09-09'
Description: Exasol Database
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Exasol Database
        Parameters:
          - DBSystemName
          - DBPassword
          - ExasolPassword
      - Label:
          default: VPC/Network
        Parameters:
          - PublicSubnetId
          - PlacementGroupParam
          - PublicIP
          - DNSServer
          - Timezone
      - Label:
          default: License Server Configuration
        Parameters:
          - LicenseServerIP
          - LicenseServerInstanceType
          - ImageId
      - Label:
          default: Node Configuration
        Parameters:
          - FirstDataNodeIP
          - DBNodeCount
          - DatabaseNodeInstanceType
          - ReplicationFactor
          - StandbyNode
          - DBEBSEncryption
          - OSDeviceVolumeSize
          - OSDeviceVolumeType
          - BlockDeviceVolumeSize
          - BlockDeviceVolumeType
          - BlockDeviceCount
      - Label:
          default: Security Group
        Parameters:
          - SecurityGroupAccess
      - Label:
          default: Security Group for Exasol DB
        Parameters:
          - DBSecurityGroup
      - Label:
          default: Key Pair
        Parameters:
          - KeyName
      - Label:
          default: License
        Parameters:
          - License
    ParameterLabels:
      DatabaseNodeInstanceType:
        default: Database Node Instance Type
      DBNodeCount:
        default: Number of Data Nodes
      PlacementGroupParam:
        default: Database Placement Group (OPTIONAL)
      DBSystemName:
        default: Database Name
      DBPassword:
        default: Exasol Database Password
      ExasolPassword:
        default: Exasol Operations Password
      DBSecurityGroup:
        default: Security Group for Exasol DB
      KeyName:
        default: AWS Key Pair
      License:
        default: License (OPTIONAL)
      PublicIP:
        default: Public IPs
      PublicSubnetId:
        default: Database Subnet-Id
      SecurityGroupAccess:
        default: Remote Access From IP
      ImageId:
        default: AMI ID
      LicenseServerInstanceType:
        default: License Server Instance Type
      LicenseServerIP:
        default: License Server IP (OPTIONAL)
      FirstDataNodeIP:
        default: First Data Node IP  (OPTIONAL)
      DNSServer:
        default: DNS Server
      Timezone:
        default: System Timezone
      DBEBSEncryption:
        default: Encrypt EBS volumes
      OSDeviceVolumeSize:
        default: Size in GB of OS Block Device Volumes
      OSDeviceVolumeType:
        default: General Purpose SSD (gp2) or Throughput Optimized HDD (st1)
      BlockDeviceVolumeSize:
        default: Size in GB of Data Block Device Volumes
      BlockDeviceVolumeType:
        default: General Purpose SSD (gp2) or Throughput Optimized HDD (st1)
      BlockDeviceCount:
        default: Number of Data Block Devices
Parameters:
  DatabaseNodeInstanceType:
    AllowedValues:
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - m4.16xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - r3.large
      - r3.2xlarge
      - r3.xlarge
      - r3.4xlarge
      - r3.8xlarge
      - r4.large
      - r4.2xlarge
      - r4.4xlarge
      - r4.8xlarge
      - r4.16xlarge
    Default: m4.4xlarge
    Description: Recommended instance types
    Type: String
  PublicIP:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: Associate public ip addresses to all instances
    Type: String
  ReplicationFactor:
    AllowedValues:
      - '1'
      - '2'
    Default: 2
    Description: The Replication factor defines between how many nodes the data is
      replicated
    Type: Number
  StandbyNode:
    Default: 0
    Description: If the replication factor is > 1, then a concurrent standby node
      can take over the work from a failed node
    Type: Number
  DBNodeCount:
    Default: '5'
    Description: Number of data node where the db resides on (min:1, max:64)
    MaxValue: 64
    MinValue: 1
    Type: Number
  DBEBSEncryption:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
    Description: Encrypt attached EBS volumes
    Type: String
  PlacementGroupParam:
    Default: ''
    Description: Use an existing Placement Group or leave blank for new placement
      group creation
    Type: String
  DBSystemName:
    AllowedPattern: '[a-zA-Z0-9_]{1,20}'
    ConstraintDescription: must only contain 1-20 alphanumeric characters and the
      underline character
    Description: ''
    MaxLength: '20'
    MinLength: '1'
    Type: String
  ExasolPassword:
    Description: Password for the exasol operations admin user
    MinLength: '1'
    NoEcho: true
    Type: String
  DBPassword:
    Description: Password for the exasol database admin user
    MinLength: '1'
    NoEcho: true
    Type: String
  DBSecurityGroup:
    Description: Security group for Exasol DB
    Type: AWS::EC2::SecurityGroup::Id
  KeyName:
    Description: ''
    Type: AWS::EC2::KeyPair::KeyName
  License:
    Default: ''
    Description: In case of a BYOL image, an already aquired license can be pasted
      here
    Type: String
  SecurityGroupAccess:
    Default: '0.0.0.0/0'
    AllowedPattern: \d{1,3}([.]\d{1,3}){3}/\d{1,2}
    ConstraintDescription: must be a CIDR block, e.g. 172.0.48.28/32
    Description: CIDR block from where to allow access (0.0.0.0/0 default route ->
      allow access from everywhere)
    Type: String
  PublicSubnetId:
    Type: AWS::EC2::Subnet::Id
  ImageId:
    AllowedValues:
      - EXASOL-6.0.6-4-BYOL
      - EXASOL-6.0.6-4
    Description: Select AMI from Marketplace
    Type: String
  LicenseServerInstanceType:
    Default: m4.large
    Description: LicenseServer InstanceType
    Type: String
  LicenseServerIP:
    Type: String
    Default: ''
    Description: If left blank, then the License Server is given an IP-Address with
      an offset of 10 from the routing prefix (an offset of at least 10 is mandatory)
  FirstDataNodeIP:
    Default: ''
    Description: If left blank, then the first Data Node is given an IP-Address with
      an offset of 1 from the License Server IP-Address (all further Data Nodes IPs
      are counting upwards from this one)
    Type: String
  OSDeviceVolumeSize:
    Default: '100'
    Description: Size in GB of OS Block Device Volumes
    MaxValue: 500
    MinValue: 100
    Type: Number
  OSDeviceVolumeType:
    AllowedValues:
      - gp2
      - st1
    Default: gp2
    Description: Either General Purpose SSD (gp2) or Throughput Optimized HDD (st1)
      (with st1 volume size must be >= 500GB)
    Type: String
  BlockDeviceVolumeSize:
    Default: '100'
    Description: Size in GB of Block Device Volumes
    MaxValue: 16000
    MinValue: 20
    Type: Number
  BlockDeviceVolumeType:
    AllowedValues:
      - gp2
      - st1
    Default: gp2
    Description: Either General Purpose SSD (gp2) or Throughput Optimized HDD (st1)
      (with st1 volume size must be >= 500GB)
    Type: String
  BlockDeviceCount:
    Default: '5'
    Description: Block Devices count (1-16)
    MaxValue: 16
    MinValue: 1
    Type: Number
  DNSServer:
    Default: 169.254.169.253
    Type: String
    Description: Default Amazon DNS Server
  Timezone:
    AllowedValues:
      - ''
      - Africa/Abidjan
      - Africa/Accra
      - Africa/Addis_Ababa
      - Africa/Algiers
      - Africa/Asmara
      - Africa/Asmera
      - Africa/Bamako
      - Africa/Bangui
      - Africa/Banjul
      - Africa/Bissau
      - Africa/Blantyre
      - Africa/Brazzaville
      - Africa/Bujumbura
      - Africa/Cairo
      - Africa/Casablanca
      - Africa/Ceuta
      - Africa/Conakry
      - Africa/Dakar
      - Africa/Dar_es_Salaam
      - Africa/Djibouti
      - Africa/Douala
      - Africa/El_Aaiun
      - Africa/Freetown
      - Africa/Gaborone
      - Africa/Harare
      - Africa/Johannesburg
      - Africa/Juba
      - Africa/Kampala
      - Africa/Khartoum
      - Africa/Kigali
      - Africa/Kinshasa
      - Africa/Lagos
      - Africa/Libreville
      - Africa/Lome
      - Africa/Luanda
      - Africa/Lubumbashi
      - Africa/Lusaka
      - Africa/Malabo
      - Africa/Maputo
      - Africa/Maseru
      - Africa/Mbabane
      - Africa/Mogadishu
      - Africa/Monrovia
      - Africa/Nairobi
      - Africa/Ndjamena
      - Africa/Niamey
      - Africa/Nouakchott
      - Africa/Ouagadougou
      - Africa/Porto-Novo
      - Africa/Sao_Tome
      - Africa/Timbuktu
      - Africa/Tripoli
      - Africa/Tunis
      - Africa/Windhoek
      - America/Adak
      - America/Anchorage
      - America/Anguilla
      - America/Antigua
      - America/Araguaina
      - America/Argentina/Buenos_Aires
      - America/Argentina/Catamarca
      - America/Argentina/ComodRivadavia
      - America/Argentina/Cordoba
      - America/Argentina/Jujuy
      - America/Argentina/La_Rioja
      - America/Argentina/Mendoza
      - America/Argentina/Rio_Gallegos
      - America/Argentina/Salta
      - America/Argentina/San_Juan
      - America/Argentina/San_Luis
      - America/Argentina/Tucuman
      - America/Argentina/Ushuaia
      - America/Aruba
      - America/Asuncion
      - America/Atikokan
      - America/Atka
      - America/Bahia
      - America/Bahia_Banderas
      - America/Barbados
      - America/Belem
      - America/Belize
      - America/Blanc-Sablon
      - America/Boa_Vista
      - America/Bogota
      - America/Boise
      - America/Buenos_Aires
      - America/Cambridge_Bay
      - America/Campo_Grande
      - America/Cancun
      - America/Caracas
      - America/Catamarca
      - America/Cayenne
      - America/Cayman
      - America/Chicago
      - America/Chihuahua
      - America/Coral_Harbour
      - America/Cordoba
      - America/Costa_Rica
      - America/Creston
      - America/Cuiaba
      - America/Curacao
      - America/Danmarkshavn
      - America/Dawson
      - America/Dawson_Creek
      - America/Denver
      - America/Detroit
      - America/Dominica
      - America/Edmonton
      - America/Eirunepe
      - America/El_Salvador
      - America/Ensenada
      - America/Fortaleza
      - America/Fort_Nelson
      - America/Fort_Wayne
      - America/Glace_Bay
      - America/Godthab
      - America/Goose_Bay
      - America/Grand_Turk
      - America/Grenada
      - America/Guadeloupe
      - America/Guatemala
      - America/Guayaquil
      - America/Guyana
      - America/Halifax
      - America/Havana
      - America/Hermosillo
      - America/Indiana/Indianapolis
      - America/Indiana/Knox
      - America/Indiana/Marengo
      - America/Indiana/Petersburg
      - America/Indianapolis
      - America/Indiana/Tell_City
      - America/Indiana/Vevay
      - America/Indiana/Vincennes
      - America/Indiana/Winamac
      - America/Inuvik
      - America/Iqaluit
      - America/Jamaica
      - America/Jujuy
      - America/Juneau
      - America/Kentucky/Louisville
      - America/Kentucky/Monticello
      - America/Knox_IN
      - America/Kralendijk
      - America/La_Paz
      - America/Lima
      - America/Los_Angeles
      - America/Louisville
      - America/Lower_Princes
      - America/Maceio
      - America/Managua
      - America/Manaus
      - America/Marigot
      - America/Martinique
      - America/Matamoros
      - America/Mazatlan
      - America/Mendoza
      - America/Menominee
      - America/Merida
      - America/Metlakatla
      - America/Mexico_City
      - America/Miquelon
      - America/Moncton
      - America/Monterrey
      - America/Montevideo
      - America/Montreal
      - America/Montserrat
      - America/Nassau
      - America/New_York
      - America/Nipigon
      - America/Nome
      - America/Noronha
      - America/North_Dakota/Beulah
      - America/North_Dakota/Center
      - America/North_Dakota/New_Salem
      - America/Ojinaga
      - America/Panama
      - America/Pangnirtung
      - America/Paramaribo
      - America/Phoenix
      - America/Port-au-Prince
      - America/Porto_Acre
      - America/Port_of_Spain
      - America/Porto_Velho
      - America/Puerto_Rico
      - America/Rainy_River
      - America/Rankin_Inlet
      - America/Recife
      - America/Regina
      - America/Resolute
      - America/Rio_Branco
      - America/Rosario
      - America/Santa_Isabel
      - America/Santarem
      - America/Santiago
      - America/Santo_Domingo
      - America/Sao_Paulo
      - America/Scoresbysund
      - America/Shiprock
      - America/Sitka
      - America/St_Barthelemy
      - America/St_Johns
      - America/St_Kitts
      - America/St_Lucia
      - America/St_Thomas
      - America/St_Vincent
      - America/Swift_Current
      - America/Tegucigalpa
      - America/Thule
      - America/Thunder_Bay
      - America/Tijuana
      - America/Toronto
      - America/Tortola
      - America/Vancouver
      - America/Virgin
      - America/Whitehorse
      - America/Winnipeg
      - America/Yakutat
      - America/Yellowknife
      - Antarctica/Casey
      - Antarctica/Davis
      - Antarctica/DumontDUrville
      - Antarctica/Macquarie
      - Antarctica/Mawson
      - Antarctica/McMurdo
      - Antarctica/Palmer
      - Antarctica/Rothera
      - Antarctica/South_Pole
      - Antarctica/Syowa
      - Antarctica/Troll
      - Antarctica/Vostok
      - Arctic/Longyearbyen
      - Asia/Aden
      - Asia/Almaty
      - Asia/Amman
      - Asia/Anadyr
      - Asia/Aqtau
      - Asia/Aqtobe
      - Asia/Ashgabat
      - Asia/Ashkhabad
      - Asia/Baghdad
      - Asia/Bahrain
      - Asia/Baku
      - Asia/Bangkok
      - Asia/Beijing
      - Asia/Beirut
      - Asia/Bishkek
      - Asia/Brunei
      - Asia/Calcutta
      - Asia/Chita
      - Asia/Choibalsan
      - Asia/Chongqing
      - Asia/Chungking
      - Asia/Colombo
      - Asia/Dacca
      - Asia/Damascus
      - Asia/Dhaka
      - Asia/Dili
      - Asia/Dubai
      - Asia/Dushanbe
      - Asia/Gaza
      - Asia/Harbin
      - Asia/Hebron
      - Asia/Ho_Chi_Minh
      - Asia/Hong_Kong
      - Asia/Hovd
      - Asia/Irkutsk
      - Asia/Istanbul
      - Asia/Jakarta
      - Asia/Jayapura
      - Asia/Jerusalem
      - Asia/Kabul
      - Asia/Kamchatka
      - Asia/Karachi
      - Asia/Kashgar
      - Asia/Kathmandu
      - Asia/Katmandu
      - Asia/Khandyga
      - Asia/Kolkata
      - Asia/Krasnoyarsk
      - Asia/Kuala_Lumpur
      - Asia/Kuching
      - Asia/Kuwait
      - Asia/Macao
      - Asia/Macau
      - Asia/Magadan
      - Asia/Makassar
      - Asia/Manila
      - Asia/Muscat
      - Asia/Nicosia
      - Asia/Novokuznetsk
      - Asia/Novosibirsk
      - Asia/Omsk
      - Asia/Oral
      - Asia/Phnom_Penh
      - Asia/Pontianak
      - Asia/Pyongyang
      - Asia/Qatar
      - Asia/Qyzylorda
      - Asia/Rangoon
      - Asia/Riyadh
      - Asia/Saigon
      - Asia/Sakhalin
      - Asia/Samarkand
      - Asia/Seoul
      - Asia/Shanghai
      - Asia/Singapore
      - Asia/Srednekolymsk
      - Asia/Taipei
      - Asia/Tashkent
      - Asia/Tbilisi
      - Asia/Tehran
      - Asia/Tel_Aviv
      - Asia/Thimbu
      - Asia/Thimphu
      - Asia/Tokyo
      - Asia/Ujung_Pandang
      - Asia/Ulaanbaatar
      - Asia/Ulan_Bator
      - Asia/Urumqi
      - Asia/Ust-Nera
      - Asia/Vientiane
      - Asia/Vladivostok
      - Asia/Yakutsk
      - Asia/Yekaterinburg
      - Asia/Yerevan
      - Atlantic/Azores
      - Atlantic/Bermuda
      - Atlantic/Canary
      - Atlantic/Cape_Verde
      - Atlantic/Faeroe
      - Atlantic/Faroe
      - Atlantic/Jan_Mayen
      - Atlantic/Madeira
      - Atlantic/Reykjavik
      - Atlantic/South_Georgia
      - Atlantic/Stanley
      - Atlantic/St_Helena
      - Australia/ACT
      - Australia/Adelaide
      - Australia/Brisbane
      - Australia/Broken_Hill
      - Australia/Canberra
      - Australia/Currie
      - Australia/Darwin
      - Australia/Eucla
      - Australia/Hobart
      - Australia/LHI
      - Australia/Lindeman
      - Australia/Lord_Howe
      - Australia/Melbourne
      - Australia/North
      - Australia/NSW
      - Australia/Perth
      - Australia/Queensland
      - Australia/South
      - Australia/Sydney
      - Australia/Tasmania
      - Australia/Victoria
      - Australia/West
      - Australia/Yancowinna
      - Brazil/Acre
      - Brazil/DeNoronha
      - Brazil/East
      - Brazil/West
      - Canada/Atlantic
      - Canada/Central
      - Canada/Eastern
      - Canada/East-Saskatchewan
      - Canada/Mountain
      - Canada/Newfoundland
      - Canada/Pacific
      - Canada/Saskatchewan
      - Canada/Yukon
      - CET
      - Chile/Continental
      - Chile/EasterIsland
      - CST6CDT
      - Cuba
      - EET
      - Egypt
      - Eire
      - EST
      - EST5EDT
      - Etc/GMT
      - Etc/GMT0
      - Etc/GMT-12
      - Etc/GMT-11
      - Etc/GMT-10
      - Etc/GMT-9
      - Etc/GMT-8
      - Etc/GMT-7
      - Etc/GMT-6
      - Etc/GMT-5
      - Etc/GMT-4
      - Etc/GMT-3
      - Etc/GMT-2
      - Etc/GMT-1
      - Etc/GMT-0
      - Etc/GMT+0
      - Etc/GMT+1
      - Etc/GMT+2
      - Etc/GMT+3
      - Etc/GMT+4
      - Etc/GMT+5
      - Etc/GMT+6
      - Etc/GMT+7
      - Etc/GMT+8
      - Etc/GMT+9
      - Etc/GMT+10
      - Etc/GMT+11
      - Etc/GMT+12
      - Etc/GMT-13
      - Etc/GMT-14
      - Etc/Greenwich
      - Etc/UCT
      - Etc/Universal
      - Etc/UTC
      - Etc/Zulu
      - Europe/Amsterdam
      - Europe/Andorra
      - Europe/Athens
      - Europe/Belfast
      - Europe/Belgrade
      - Europe/Berlin
      - Europe/Bratislava
      - Europe/Brussels
      - Europe/Bucharest
      - Europe/Budapest
      - Europe/Busingen
      - Europe/Chisinau
      - Europe/Copenhagen
      - Europe/Dublin
      - Europe/Gibraltar
      - Europe/Guernsey
      - Europe/Helsinki
      - Europe/Isle_of_Man
      - Europe/Istanbul
      - Europe/Jersey
      - Europe/Kaliningrad
      - Europe/Kiev
      - Europe/Lisbon
      - Europe/Ljubljana
      - Europe/London
      - Europe/Luxembourg
      - Europe/Madrid
      - Europe/Malta
      - Europe/Mariehamn
      - Europe/Minsk
      - Europe/Monaco
      - Europe/Moscow
      - Europe/Nicosia
      - Europe/Oslo
      - Europe/Paris
      - Europe/Podgorica
      - Europe/Prague
      - Europe/Riga
      - Europe/Rome
      - Europe/Samara
      - Europe/San_Marino
      - Europe/Sarajevo
      - Europe/Simferopol
      - Europe/Skopje
      - Europe/Sofia
      - Europe/Stockholm
      - Europe/Tallinn
      - Europe/Tirane
      - Europe/Tiraspol
      - Europe/Uzhgorod
      - Europe/Vaduz
      - Europe/Vatican
      - Europe/Vienna
      - Europe/Vilnius
      - Europe/Volgograd
      - Europe/Warsaw
      - Europe/Zagreb
      - Europe/Zaporozhye
      - Europe/Zurich
      - Factory
      - GB
      - GB-Eire
      - GMT
      - GMT0
      - GMT-0
      - GMT+0
      - Greenwich
      - Hongkong
      - HST
      - Iceland
      - Indian/Antananarivo
      - Indian/Chagos
      - Indian/Christmas
      - Indian/Cocos
      - Indian/Comoro
      - Indian/Kerguelen
      - Indian/Mahe
      - Indian/Maldives
      - Indian/Mauritius
      - Indian/Mayotte
      - Indian/Reunion
      - Iran
      - Israel
      - Jamaica
      - Japan
      - Kwajalein
      - Libya
      - MET
      - Mexico/BajaNorte
      - Mexico/BajaSur
      - Mexico/General
      - MST
      - MST7MDT
      - Navajo
      - NZ
      - NZ-CHAT
      - Pacific/Apia
      - Pacific/Auckland
      - Pacific/Bougainville
      - Pacific/Chatham
      - Pacific/Chuuk
      - Pacific/Easter
      - Pacific/Efate
      - Pacific/Enderbury
      - Pacific/Fakaofo
      - Pacific/Fiji
      - Pacific/Funafuti
      - Pacific/Galapagos
      - Pacific/Gambier
      - Pacific/Guadalcanal
      - Pacific/Guam
      - Pacific/Honolulu
      - Pacific/Johnston
      - Pacific/Kiritimati
      - Pacific/Kosrae
      - Pacific/Kwajalein
      - Pacific/Majuro
      - Pacific/Marquesas
      - Pacific/Midway
      - Pacific/Nauru
      - Pacific/Niue
      - Pacific/Norfolk
      - Pacific/Noumea
      - Pacific/Pago_Pago
      - Pacific/Palau
      - Pacific/Pitcairn
      - Pacific/Pohnpei
      - Pacific/Ponape
      - Pacific/Port_Moresby
      - Pacific/Rarotonga
      - Pacific/Saipan
      - Pacific/Samoa
      - Pacific/Tahiti
      - Pacific/Tarawa
      - Pacific/Tongatapu
      - Pacific/Truk
      - Pacific/Wake
      - Pacific/Wallis
      - Pacific/Yap
      - Poland
      - Portugal
      - PRC
      - PST8PDT
      - ROC
      - ROK
      - Singapore
      - Turkey
      - UCT
      - Universal
      - US/Alaska
      - US/Aleutian
      - US/Arizona
      - US/Central
      - US/Eastern
      - US/East-Indiana
      - US/Hawaii
      - US/Indiana-Starke
      - US/Michigan
      - US/Mountain
      - US/Pacific
      - US/Pacific-New
      - US/Samoa
      - UTC
      - WET
      - W-SU
      - Zulu
    Default: Europe/Berlin
    Description: AWS region's timezone
    Type: String
Mappings:
  regions:
    ap-northeast-1:
      RegionKey: apnortheast1
    ap-northeast-2:
      RegionKey: apnortheast2
    ap-south-1:
      RegionKey: apsouth1
    ap-southeast-1:
      RegionKey: apsoutheast1
    ap-southeast-2:
      RegionKey: apsoutheast2
    ca-central-1:
      RegionKey: cacentral1
    eu-central-1:
      RegionKey: eucentral1
    eu-west-1:
      RegionKey: euwest1
    eu-west-2:
      RegionKey: euwest2
    sa-east-1:
      RegionKey: saeast1
    us-east-1:
      RegionKey: useast1
    us-east-2:
      RegionKey: useast2
    us-gov-west-1:
      RegionKey: usgovwest1
    us-west-1:
      RegionKey: uswest1
    us-west-2:
      RegionKey: uswest2
  apnortheast1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-bd00bedb
    EXASOL-6.0.6-4:
      AMI: ami-24f94042
  apnortheast2:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-822b8cec
    EXASOL-6.0.6-4:
      AMI: ami-0d288f63
  apsouth1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-d39ed0bc
    EXASOL-6.0.6-4:
      AMI: ami-f481cf9b
  apsoutheast1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-63e8b800
    EXASOL-6.0.6-4:
      AMI: ami-64e8b807
  apsoutheast2:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-7b9d6819
    EXASOL-6.0.6-4:
      AMI: ami-e6916484
  cacentral1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-6759e203
    EXASOL-6.0.6-4:
      AMI: ami-615be005
  eucentral1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-2ed85441
    EXASOL-6.0.6-4:
      AMI: ami-a9df53c6
  euwest1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-ad03b3d4
    EXASOL-6.0.6-4:
      AMI: ami-7400b00d
  euwest2:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-30a7b854
    EXASOL-6.0.6-4:
      AMI: ami-15a8b771
  euwest3:
    EXASOL-6.0.6-4-BYOL:
      AMI: ''
    EXASOL-6.0.6-4:
      AMI: ami-eb70c796
  saeast1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-3d440051
    EXASOL-6.0.6-4:
      AMI: ami-1c470370
  useast1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-65a0331f
    EXASOL-6.0.6-4:
      AMI: ami-0ea53674
  useast2:
    EXASOL-6.0.6-4-BYOL:
      AMI: ''
    EXASOL-6.0.6-4:
      AMI: ami-a780aec2
  usgovwest1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ''
    EXASOL-6.0.6-4:
      AMI: ''
  uswest1:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-07093267
    EXASOL-6.0.6-4:
      AMI: ami-720a3112
  uswest2:
    EXASOL-6.0.6-4-BYOL:
      AMI: ami-4aa77932
    EXASOL-6.0.6-4:
      AMI: ami-a7ab75df
Conditions:
  PlacementGroupNotSet: !Equals
    - !Ref 'PlacementGroupParam'
    - ''
Resources:
  PlacementGroup:
    Type: AWS::EC2::PlacementGroup
    Condition: PlacementGroupNotSet
    Properties:
      Strategy: cluster
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'EC2Role'
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: EC2Policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:Describe*
                Resource: '*'
              - Effect: Allow
                Action:
                  - ec2:RunInstances
                  - ec2:TerminateInstances
                  - ec2:StartInstances
                  - ec2:StopInstances
                  - ec2:RebootInstances
                  - ec2:CreateTags
                  - ec2:ModifyInstanceAttribute
                  - ec2:CreateVolume
                  - ec2:DeleteVolume
                  - ec2:AttachVolume
                  - ec2:DetachVolume
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :subnet/
                      - !Ref 'PublicSubnetId'
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :network-interface/*
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :instance/*
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :volume/*
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ::image/
                      - !FindInMap
                        - !FindInMap
                          - regions
                          - !Ref 'AWS::Region'
                          - RegionKey
                        - !Ref 'ImageId'
                        - AMI
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :key-pair/
                      - !Ref 'KeyName'
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :security-group/
                      - !Ref 'DBSecurityGroup'
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :placement-group/
                      - !If
                        - PlacementGroupNotSet
                        - !Ref 'PlacementGroup'
                        - !Ref 'PlacementGroupParam'
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:iam::'
                      - !Ref 'AWS::AccountId'
                      - :role/
                      - !Ref 'AWS::StackName'
                      - -*
  EC2Instances:
    Type: Custom::EC2Instances
    Properties:
      ServiceToken: !GetAtt 'CreateEC2InstanceLambda.Arn'
      BlockDeviceMappings: []
      ImageId: !FindInMap
        - !FindInMap
          - regions
          - !Ref 'AWS::Region'
          - RegionKey
        - !Ref 'ImageId'
        - AMI
      InstanceType: !Ref 'DatabaseNodeInstanceType'
      IamInstanceProfile:
        Name: !Ref 'InstanceProfile'
      KeyName: !Ref 'KeyName'
      MinCount: !Ref 'DBNodeCount'
      MaxCount: !Ref 'DBNodeCount'
      NetworkInterfaces:
        - AssociatePublicIpAddress: !Ref 'PublicIP'
          Groups:
            - !Ref 'DBSecurityGroup'
          DeviceIndex: 0
          PrivateIpAddress: !GetAtt 'IpCalc.FirstDataNodeIp'
          SubnetId: !Ref 'PublicSubnetId'
      Placement:
        GroupName: !If
          - PlacementGroupNotSet
          - !Ref 'PlacementGroup'
          - !Ref 'PlacementGroupParam'
      TagSpecifications:
        - ResourceType: instance
          Tags:
            - Key: Name
              Value: !Join
                - ''
                - - !Ref 'AWS::StackName'
                  - -data_node
      UserData: !Base64
        Fn::Base64: !Join
          - ''
          - - "mkdir -p /var/lib/exawolke/\n"
            - LICENSE='
            - !Ref 'License'
            - "'\n"
            - "if ! [[ -z ${LICENSE//} ]]; then echo $LICENSE > /usr/opt/EXAWolke/etc/exasolution.lic;\
              \ fi\n"
            - FIRSTDATANODEIP='
            - !GetAtt 'IpCalc.FirstDataNodeIp'
            - "'\n"
            - LICENSE_SERVER_IP='
            - !GetAtt 'IpCalc.LicenseServerIp'
            - "'\n"
            - DBNODECOUNT='
            - !Ref 'DBNodeCount'
            - "'\n"
            - DB_STANDBY_NODES='
            - !Ref 'StandbyNode'
            - "'\n"
            - COS_NETWORK='
            - !GetAtt 'GetSubnetCidr.CidrBlock'
            - "'\n"
            - "ip2int()\n"
            - "{ \n"
            - "  local a b c d\n"
            - "  { IFS=. read a b c d; } <<< $1\n"
            - "  echo $(((((((a << 8) | b) << 8) | c) << 8) | d))\n"
            - "}\n"
            - "function get_node_list {\n"
            - "DATANODE_FIRST=$(($(ip2int ${FIRSTDATANODEIP}) -$(ip2int ${COS_NETWORK%/*})))\n"
            - "DATANODE_LAST=$((DATANODE_FIRST+DBNODECOUNT-1+DB_STANDBY_NODES))\n"
            - "LICENSE_SERVER_IP_OFFSET=$(($(ip2int ${LICENSE_SERVER_IP}) -$(ip2int\
              \ ${COS_NETWORK%/*}) -10))\n"
            - "echo $(seq $DATANODE_FIRST $DATANODE_LAST | while read a; do printf\
              \ 'n%04d  ' $((a-LICENSE_SERVER_IP_OFFSET)); done)\n"
            - "}\n"
            - "ln -sf /var/lib/exawolke/cluster.conf\n"
            - "cat <<-EOF > /var/lib/exawolke/cluster.conf\n"
            - "NODES='$(get_node_list)'\n"
            - PASSWORD_DB='
            - !Ref 'DBPassword'
            - "'\n"
            - PASSWORD='
            - !Ref 'ExasolPassword'
            - "'\n"
            - ST_REPLICATION_FACTOR='
            - !Ref 'ReplicationFactor'
            - "'\n"
            - DB_NAME='
            - !Ref 'DBSystemName'
            - "'\n"
            - DB_STANDBY_NODES='
            - !Ref 'StandbyNode'
            - "'\n"
            - DATA_EBS_ENCRYPTED='
            - !Ref 'DBEBSEncryption'
            - "'\n"
            - "DB_RESTORE_BACKUP_SOURCE=''\n"
            - "TIMEZONE='Europe/Berlin'\n"
            - DNS_SERVER_2='
            - !Ref 'DNSServer'
            - "'\n"
            - DEFAULT_GATEWAY='
            - !GetAtt 'IpCalc.DefaultGateWay'
            - "'\n"
            - "DB_RESTORE_BACKUP_SOURCE=''\n"
            - "KERNEL_PARAMETERS=''\n"
            - NETWORK_RANGE='
            - !GetAtt 'GetSubnetCidr.CidrBlock'
            - "'\n"
            - COS_NETWORK='
            - !GetAtt 'GetSubnetCidr.CidrBlock'
            - "'\n"
            - "COS_NETWORK_OFFSET='0'\n"
            - LICENSE_SERVER_IP='
            - !GetAtt 'IpCalc.LicenseServerIp'
            - "'\n"
            - "LICENSE_SERVER_IP_OFFSET=$(($(ip2int ${LICENSE_SERVER_IP}) -$(ip2int\
              \ ${COS_NETWORK%/*}) -10))\n"
            - "TESTS=''\n"
            - TAG='
            - !Ref 'AWS::StackName'
            - "'\n"
            - PLACEMENT_GROUP='
            - !If
              - PlacementGroupNotSet
              - !Ref 'PlacementGroup'
              - !Ref 'PlacementGroupParam'
            - "'\n"
            - EOF
            - "\n"
            - "\n"
  CreateEC2InstanceLambda:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.handler
      Role: !GetAtt 'CreateEC2InstanceLambdaRole.Arn'
      Code:
        ZipFile: !Join
          - ''
          - - '''use strict'';'
            - const response = require('cfn-response');
            - const AWS = require('aws-sdk');
            - const regexIP = /\b((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/;
            - function toInt(ip) {return ip.split('.').map((octet, index, array) =>
              {return parseInt(octet) * Math.pow(256, (array.length - index - 1));}).reduce((prev,
              curr) => {return prev + curr;});}
            - function toIP(value) {const result = /\d+/.exec(value);value = result[0];return
              [(value>>24)&0xff, (value>>16)&0xff, (value>>8)&0xff, value&0xff].join('.');}
            - exports.handler = function(event, context) {
            - let physicalId = event.PhysicalResourceId || 'none';
            - function success(data) {
            - return response.send(event, context, response.SUCCESS, data, physicalId);
            - '}'
            - function failed(e) {
            - return response.send(event, context, response.FAILED, e, physicalId);
            - '}'
            - let ec2 = new AWS.EC2();
            - let instances = [];
            - let numberOfInstances = parseInt(event.ResourceProperties.MaxCount)
              + parseInt(
            - !Ref 'StandbyNode'
            - );
            - let privateIPAddress = toInt(event.ResourceProperties.NetworkInterfaces[0].PrivateIpAddress);
            - event.ResourceProperties.MaxCount=1;
            - event.ResourceProperties.MinCount=1;
            - event.ResourceProperties.NetworkInterfaces[0].AssociatePublicIpAddress
              = (event.ResourceProperties.NetworkInterfaces[0].AssociatePublicIpAddress
              == 'true');
            - delete event.ResourceProperties.ServiceToken;
            - 'event.ResourceProperties.BlockDeviceMappings.push({''DeviceName'':
              ''/dev/xvdb'', ''Ebs'': { ''Encrypted'': '
            - !Ref 'DBEBSEncryption'
            - ', ''VolumeSize'': '
            - !Ref 'OSDeviceVolumeSize'
            - ', ''VolumeType'': '''
            - !Ref 'OSDeviceVolumeType'
            - '''}});'
            - 'for (let i=1; i <= '
            - !Ref 'BlockDeviceCount'
            - ; i++) {
            - 'event.ResourceProperties.BlockDeviceMappings.push({''DeviceName'':
              ''/dev/xvd''+String.fromCharCode(i+98), ''Ebs'': { ''VolumeSize'': '
            - !Ref 'BlockDeviceVolumeSize'
            - ', ''VolumeType'': '''
            - !Ref 'BlockDeviceVolumeType'
            - '''}});'
            - '}'
            - for (let i=0; i < numberOfInstances; i++) {
            - if (event.RequestType == 'Create') {
            - event.ResourceProperties.NetworkInterfaces[0].PrivateIpAddress = toIP(privateIPAddress
              + i);
            - ec2.runInstances(event.ResourceProperties).promise().then((data)=> {
            - instances = instances.concat(data.Instances.map((data)=> data.InstanceId));
            - physicalId = instances.join(':');
            - 'return ec2.waitFor(''instanceRunning'', {InstanceIds: instances}).promise();'
            - '}).then((data)=> success({Instances: instances})'
            - ).catch((e)=> failed(e));
            - '} else if (event.RequestType == ''Delete'') {'
            - if (physicalId == 'none') {
            - return success({});
            - '}'
            - 'let deleteParams = {InstanceIds: physicalId.split('':'')};'
            - ec2.terminateInstances(deleteParams).promise().then((data)=>
            - ec2.waitFor('instanceTerminated', deleteParams).promise()
            - ).then((data)=>success({})
            - ).catch((e)=>failed(e));
            - '} else {'
            - 'return failed({Error: ''In-place updates not supported.''});'
            - '}'
            - '}'
            - '};'
      Runtime: nodejs8.10
      Timeout: '300'
  GetSubnetCidrFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.handler
      Role: !GetAtt 'HelperLambdaRole.Arn'
      Code:
        ZipFile: !Join
          - ''
          - - '''use strict'';'
            - const response = require('cfn-response');
            - const AWS = require('aws-sdk');
            - const ec2 = new AWS.EC2();
            - exports.handler = function(event, context) {
            - '   let params = {'
            - '       DryRun: false,'
            - '       SubnetIds: [event.ResourceProperties.SubnetId]'
            - '   };'
            - '   ec2.describeSubnets(params, function(err, data) {'
            - '       if (err) { console.log(err, err.stack); }'
            - '       else { return response.send(event, context, response.SUCCESS,
              { CidrBlock: data.Subnets[0].CidrBlock, VpcId: data.Subnets[0].VpcId
              }); }'
            - '   });'
            - '};'
      Runtime: nodejs8.10
      Timeout: '300'
  GetSubnetCidr:
    Type: Custom::GetSubnetCidr
    Properties:
      ServiceToken: !GetAtt 'GetSubnetCidrFunction.Arn'
      SubnetId: !Ref 'PublicSubnetId'
  IpCalcFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.handler
      Role: !GetAtt 'HelperLambdaRole.Arn'
      Code:
        ZipFile: !Join
          - ''
          - - '''use strict'';'
            - const response = require('cfn-response');
            - const regexIP = /\b((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/;
            - function toInt(ip) {return ip.split('.').map((octet, index, array) =>
              {return parseInt(octet) * Math.pow(256, (array.length - index - 1));}).reduce((prev,
              curr) => {return prev + curr;});}
            - function toIP(value) {const result = /\d+/.exec(value);value = result[0];return
              [(value>>24)&0xff, (value>>16)&0xff, (value>>8)&0xff, value&0xff].join('.');}
            - exports.handler = function(event, context) {
            - '       let DefaultGateWay = toIP(toInt(event.ResourceProperties.SubnetCidr)
              + 1);'
            - '       let LicenseServerIp = (event.ResourceProperties.LicenseServerIp
              == '''' || toInt(event.ResourceProperties.LicenseServerIp) < (toInt(DefaultGateWay)
              + 9)) ? toIP(toInt(event.ResourceProperties.SubnetCidr) + 10) : event.ResourceProperties.LicenseServerIp;'
            - '       let FirstDataNodeIp = (event.ResourceProperties.FirstDataNodeIp
              == '''' || toInt(event.ResourceProperties.FirstDataNodeIp) < toInt(LicenseServerIp))
              ? toIP(toInt(LicenseServerIp) + 1) : event.ResourceProperties.FirstDataNodeIp;'
            - '       return response.send(event, context, response.SUCCESS, { DefaultGateWay:
              DefaultGateWay, LicenseServerIp: LicenseServerIp, FirstDataNodeIp: FirstDataNodeIp
              });'
            - '};'
      Runtime: nodejs8.10
      Timeout: '300'
  IpCalc:
    Type: Custom::IpCalc
    Properties:
      ServiceToken: !GetAtt 'IpCalcFunction.Arn'
      SubnetCidr: !GetAtt 'GetSubnetCidr.CidrBlock'
      LicenseServerIp: !Ref 'LicenseServerIP'
      FirstDataNodeIp: !Ref 'FirstDataNodeIP'
  HelperLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: LambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:Describe*
                Resource: '*'
  CreateEC2InstanceLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: LambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:Describe*
                Resource: '*'
              - Effect: Allow
                Action:
                  - ec2:RunInstances
                  - ec2:TerminateInstances
                  - ec2:CreateTags
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :subnet/
                      - !Ref 'PublicSubnetId'
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :network-interface/*
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :instance/*
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :volume/*
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ::image/
                      - !FindInMap
                        - !FindInMap
                          - regions
                          - !Ref 'AWS::Region'
                          - RegionKey
                        - !Ref 'ImageId'
                        - AMI
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :key-pair/
                      - !Ref 'KeyName'
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :security-group/
                      - !Ref 'DBSecurityGroup'
                  - !Join
                    - ''
                    - - 'arn:aws:ec2:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :placement-group/
                      - !If
                        - PlacementGroupNotSet
                        - !Ref 'PlacementGroup'
                        - !Ref 'PlacementGroupParam'
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:iam::'
                      - !Ref 'AWS::AccountId'
                      - :role/
                      - !Ref 'AWS::StackName'
                      - -*
  LicenseServer:
    Properties:
      ImageId: !FindInMap
        - !FindInMap
          - regions
          - !Ref 'AWS::Region'
          - RegionKey
        - !Ref 'ImageId'
        - AMI
      InstanceType: !Ref 'LicenseServerInstanceType'
      KeyName: !Ref 'KeyName'
      IamInstanceProfile: !Ref 'InstanceProfile'
      NetworkInterfaces:
        - AssociatePublicIpAddress: !Ref 'PublicIP'
          GroupSet:
            - !Ref 'DBSecurityGroup'
          DeviceIndex: 0
          PrivateIpAddress: !GetAtt 'IpCalc.LicenseServerIp'
          SubnetId: !Ref 'PublicSubnetId'
      SourceDestCheck: 'false'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - !Ref 'AWS::StackName'
              - -management_node
      UserData: !Base64
        Fn::Base64: !Join
          - ''
          - - "mkdir -p /var/lib/exawolke/\n"
            - LICENSE='
            - !Ref 'License'
            - "'\n"
            - "if ! [[ -z ${LICENSE//} ]]; then echo $LICENSE > /usr/opt/EXAWolke/etc/exasolution.lic;\
              \ fi\n"
            - FIRSTDATANODEIP='
            - !GetAtt 'IpCalc.FirstDataNodeIp'
            - "'\n"
            - LICENSE_SERVER_IP='
            - !GetAtt 'IpCalc.LicenseServerIp'
            - "'\n"
            - DBNODECOUNT='
            - !Ref 'DBNodeCount'
            - "'\n"
            - DB_STANDBY_NODES='
            - !Ref 'StandbyNode'
            - "'\n"
            - COS_NETWORK='
            - !GetAtt 'GetSubnetCidr.CidrBlock'
            - "'\n"
            - "ip2int()\n"
            - "{ \n"
            - "  local a b c d\n"
            - "  { IFS=. read a b c d; } <<< $1\n"
            - "  echo $(((((((a << 8) | b) << 8) | c) << 8) | d))\n"
            - "}\n"
            - "function get_node_list {\n"
            - "DATANODE_FIRST=$(($(ip2int ${FIRSTDATANODEIP}) -$(ip2int ${COS_NETWORK%/*})))\n"
            - "DATANODE_LAST=$((DATANODE_FIRST+DBNODECOUNT-1+DB_STANDBY_NODES))\n"
            - "LICENSE_SERVER_IP_OFFSET=$(($(ip2int ${LICENSE_SERVER_IP}) -$(ip2int\
              \ ${COS_NETWORK%/*}) -10))\n"
            - "echo $(seq $DATANODE_FIRST $DATANODE_LAST | while read a; do printf\
              \ 'n%04d  ' $((a-LICENSE_SERVER_IP_OFFSET)); done)\n"
            - "}\n"
            - "ln -sf /var/lib/exawolke/cluster.conf\n"
            - "cat <<-EOF > /var/lib/exawolke/cluster.conf\n"
            - "NODES='$(get_node_list)'\n"
            - PASSWORD_DB='
            - !Ref 'DBPassword'
            - "'\n"
            - PASSWORD='
            - !Ref 'ExasolPassword'
            - "'\n"
            - ST_REPLICATION_FACTOR='
            - !Ref 'ReplicationFactor'
            - "'\n"
            - DB_NAME='
            - !Ref 'DBSystemName'
            - "'\n"
            - DB_STANDBY_NODES='
            - !Ref 'StandbyNode'
            - "'\n"
            - DATA_EBS_ENCRYPTED='
            - !Ref 'DBEBSEncryption'
            - "'\n"
            - "DB_RESTORE_BACKUP_SOURCE=''\n"
            - "TIMEZONE='Europe/Berlin'\n"
            - DNS_SERVER_2='
            - !Ref 'DNSServer'
            - "'\n"
            - DEFAULT_GATEWAY='
            - !GetAtt 'IpCalc.DefaultGateWay'
            - "'\n"
            - "DB_RESTORE_BACKUP_SOURCE=''\n"
            - "KERNEL_PARAMETERS=''\n"
            - NETWORK_RANGE='
            - !GetAtt 'GetSubnetCidr.CidrBlock'
            - "'\n"
            - COS_NETWORK='
            - !GetAtt 'GetSubnetCidr.CidrBlock'
            - "'\n"
            - "COS_NETWORK_OFFSET='0'\n"
            - LICENSE_SERVER_IP='
            - !GetAtt 'IpCalc.LicenseServerIp'
            - "'\n"
            - "LICENSE_SERVER_IP_OFFSET=$(($(ip2int ${LICENSE_SERVER_IP}) -$(ip2int\
              \ ${COS_NETWORK%/*}) -10))\n"
            - "TESTS=''\n"
            - TAG='
            - !Ref 'AWS::StackName'
            - "'\n"
            - PLACEMENT_GROUP='
            - !If
              - PlacementGroupNotSet
              - !Ref 'PlacementGroup'
              - !Ref 'PlacementGroupParam'
            - "'\n"
            - EOF
            - "\n"
            - "\n"
    Type: AWS::EC2::Instance
Outputs:
  LicenseServerPublicIP:
    Value: !GetAtt [LicenseServer, PublicIp]
